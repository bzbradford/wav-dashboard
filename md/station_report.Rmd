---
output:
  pdf_document:
    latex_engine: xelatex
    df_print: kable
fontsize: 11pt
geometry: left=.75in, right=.75in, top=1in, bottom=1in
header-includes:
  - \usepackage{longtable}
  - \usepackage{fancyhdr} # page header and footer
  - \usepackage{lastpage} # allow page 'X of Y'
  - \usepackage{fontspec}
  - \setmainfont{Times New Roman}
params:
  year: NA
  stn: NA
  data: NA
---

```{r setup, include = FALSE}
library(knitr)
knitr::opts_chunk$set(echo = F, warning = T, results = "asis")
options(knitr.kable.NA = "-")
options(scipen = 999)
stn <- params$stn
baseline <- params$data$baseline %>%
  mutate(formatted_date = format(date, "%b %d")) # nbsp = alt+255
nutrient <- params$data$nutrient
thermistor <- params$data$thermistor
n_baseline <- nrow(baseline)
n_nutrient <- nutrient %>% drop_na(tp) %>% nrow()
n_thermistor <- n_distinct(thermistor$date)

```

\pagestyle{fancy}
\setlength{\headheight}{14pt}
\lhead{`r stn$label`}
\rhead{`r params$year` WAV Fieldwork Report}
\lfoot{\url{https://wateractionvolunteers.org}}
\cfoot{}
\rfoot{Page \thepage\ of \pageref{LastPage}}
\title{Water Action Volunteers}

# `r params$year` WAV Fieldwork Report - `r stn$station_name`

```{r stn-map, fig.height=3}
makeReportMap(stn)
```

# Station information

Location: `r stn$latitude`, `r stn$longitude`\
County: `r stn$county_name` (`r stn$dnr_region`)\
Waterbody: `r stn$waterbody` (WBIC: `r stn$wbic`)\
HUC12 Subwatershed: `r stn$sub_watershed` (`r stn$huc12`)\
HUC10 Watershed: `r stn$watershed` (`r stn$huc10`)\
DNR Watershed: `r stn$dnr_watershed_name` (`r stn$dnr_watershed_code`)\
HUC8 Subbasin: `r stn$sub_basin` (`r stn$huc8`)\
Major Basin: `r stn$major_basin`

# Data collection summary

Baseline monitoring: `r n_baseline` fieldwork events\
Nutrient monitoring: `r n_nutrient` monthly samples\
Temperature logger: `r n_thermistor` days deployed

\newpage

```{r baseline, eval=n_baseline>0}
cat("# Baseline monitoring summary\n")
baseline %>%
  select(
    `Date` = formatted_date,
    `Air temp (°C)` = ambient_air_temp,
    `Water temp (°C)` = water_temp,
    `DO (mg/L)` = d_o,
    `DO % sat.` = d_o_percent_saturation,
    `pH` = ph,
    `Spec. cond. (μS/cm)` = specific_cond,
    `Transparency (cm)` = transparency_average,
    `Streamflow (cfs)` = streamflow_cfs
  ) %>% kable() %>% print()

cat("\n\n# Streamflow details\n")
baseline %>%
  mutate(across(flow_method_used, ~gsub("WAV Float Method", "Float", .x))) %>%
  select(
    `Date` = formatted_date,
    `Stream width (ft)` = stream_width,
    `Average depth (ft)` = average_stream_depth,
    `Surface velocity (ft/s)` = average_surface_velocity,
    `Streamflow (cfs)` = streamflow_cfs,
    `Flow method` = flow_method_used
  ) %>% kable() %>% print()

cat("\n\n# Additional fieldwork details\n")
baseline %>%
  select(
    `Date` = formatted_date,
    `Fieldwork #` = fieldwork_seq_no,
    `Group name(s)` = group_desc,
    `Weather conditions` = weather_conditions,
    `Weather last 2 days` = weather_last_2_days,
    `Fieldwork comments` = fieldwork_comment,
    `Streamflow comments` = streamflow_comments
  ) %>% kable() %>% print()

cat("\n\\newpage\n")
cat("\n# Temperature\n\n")

makeReportPlots(baseline, type = "temp") %>% print()

cat("\n\n**Temperature:** The chart shows both the recorded air temperature and water temperature. Cold streams generally provide better habitat because they can contain higher levels of dissolved oxygen, and higher water temperatures may indicate shallow, pooled, or stagnant water. These values were recorded during baseline fieldwork events; if there was a water temperature data logger deployed, those measurements appear later in this report.\n")

cat("\n\\newpage\n")
cat("\n# Dissolved Oxygen\n\n")
makeReportPlots(baseline, type = "do") %>% print()
cat("\n\n**Dissolved Oxygen:** The amount of dissolved oxygen (D.O.) in a stream is critical for aquatic life, particularly larger animals like fish. 5 mg/L is considered the minimum level for fish, while 7 mg/L is the minimum required by trout in the spawning season. Colder waters can support higher concentrations of dissolved oxygen than warmer waters. The percent saturation refers to the equilibrium amount of oxygen that can dissolve into the water from the atmosphere. Higher than 100% D.O. saturation means oxygen is being actively added to the water, either by aquatic life or by air-water mixing. Lower than 100% D.O. saturation means the dissolved oxygen has been depleted below equilibrium level by plant or algal respiration or decomposition.\n")

cat("\n\\newpage\n")
cat("\n# Transparency / Water clarity\n\n")
makeReportPlots(baseline, type = "trans") %>% print()
cat("\n\n**Transparency:** These measurements reflect the turbidity, or clarity, of the stream water. Lower transparency means the water is cloudier/murkier and could indicate a recent storm event kicking up silt and mud in the stream. Lower transparency isn't necessarily bad but can be associated with warm waters with low dissolved oxygen and lots of suspended algae.\n")

cat("\n\\newpage\n")
cat("\n# Streamflow\n\n")
makeReportPlots(baseline, type = "flow") %>% print()
cat("\n\n**Stream flow:** Stream flow measurements give you an idea of the general size of the stream. Periods of higher than normal stream flow would suggest recent rains in the watershed. Most streams have a consistent and predictable stream flow based on the size of the watershed that they drain, but stream flow will ‘pulse’ after rain and storm events, returning to baseflow after several days.\n")

```

```{r nutrient, eval=n_nutrient>0}
cat("\n\\newpage\n")
cat("\n# Nutrient monitoring summary\n")
```

```{r thermistor, eval=n_thermistor>0}
cat("\n\\newpage\n")
cat("\n# Temperature logger summary\n")
```


